summary: Create an nginx container as a reverse proxy for an nginx server serving static content
execute: |

  # Clean up on exit
  trap "docker stop nginx-proxy-rock nginx-backend-rock >/dev/null 2>&1 || true" EXIT

  # Create docker network for communication between containers
  docker network create test-network >/dev/null 2>&1 || true

  # Run the Nginx backend container
  docker run -d --rm --name nginx-backend-rock -p 48080:80 \
    -v $(pwd)/html:/var/www/html:ro \
    --network test-network \
    nginx:1.28-26.04

  # Wait for port 48080 to be ready
  sleep 5

  # Get checksums of original and retrieved file
  orig_checksum=$(md5sum $(pwd)/html/index.html | awk '{print $1}')
  retrieved_checksum=$(curl -sS http://127.0.0.1:48080 | md5sum | awk '{print $1}')

  # Check that the checksums match
  if [ "$orig_checksum" != "$retrieved_checksum" ]; then
    echo "Checksum mismatch: original ($orig_checksum) vs retrieved ($retrieved_checksum)"
    exit 1
  fi

  # Start a container to act as a reverse proxy
  docker run -d --rm --name nginx-proxy-rock -p 48070:48070 \
    -v $(pwd)/nginx_reverse_proxy.conf:/etc/nginx/nginx.conf:ro \
    --network test-network \
    nginx:1.28-26.04

  # Wait for port 48070 to be ready
  sleep 5

  # Get checksums of original and retrieved file via the reverse proxy
  proxied_retrieved_checksum=$(curl -sS http://127.0.0.1:48070 | md5sum | awk '{print $1}')

  # Check that the checksums match
  if [ "$orig_checksum" != "$proxied_retrieved_checksum" ]; then
    echo "Checksum mismatch via reverse proxy: original ($orig_checksum) vs retrieved ($proxied_retrieved_checksum)"
    exit 1
  fi
