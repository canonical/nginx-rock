name: nginx
version: "1.23.3"
build-base: ubuntu:22.04
base: ubuntu:22.04
summary: nginx web server
description: nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server.
license: Apache-2.0
platforms:
  amd64:

cmd: ["nginx", "-g", "daemon off;"]

parts:

  nginx-user:
    plugin: nil
    overlay-script: |
      set -x
      chroot $CRAFT_OVERLAY
      useradd -M -U -r nginx

  nginx:
    plugin: autotools
    after:
      - nginx-user
    source: https://nginx.org/download/nginx-1.23.3.tar.gz
    build-packages:
      - libgd-dev
      - libpcre3-dev
      - libssl-dev
      - zlib1g-dev
    stage-packages:
      - ca-certificates_data
    autotools-configure-parameters:
      - --prefix=/etc/nginx
      - --user=nginx
      - --group=nginx
      - --sbin-path=/usr/sbin/nginx
      - --conf-path=/etc/nginx/nginx.conf
      - --http-log-path=/var/log/nginx/access.log
      - --error-log-path=/var/log/nginx/error.log
      - --lock-path=/var/run/nginx.lock
      - --pid-path=/var/run/nginx.pid
      - --with-http_ssl_module
      - --modules-path=$CRAFT_PART_INSTALL/usr/lib/nginx/modules
      - --with-http_v2_module
      - --with-stream
      - --with-stream_realip_module
      - --with-stream_ssl_module
      - --with-stream_ssl_preread_module
      - --with-http_addition_module
      - --with-http_mp4_module
      - --with-threads
      - --http-client-body-temp-path=/var/cache/nginx/client_temp
      - --http-proxy-temp-path=/var/cache/nginx/proxy_temp
      - --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp
      - --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp
      - --http-scgi-temp-path=/var/cache/nginx/scgi_temp
      - --with-compat
      - --with-file-aio
      - --with-http_auth_request_module
      - --with-http_dav_module
      - --with-http_flv_module
      - --with-http_gunzip_module
      - --with-http_gzip_static_module
      - --with-http_random_index_module
      - --with-http_realip_module
      - --with-http_secure_link_module
      - --with-http_slice_module
      - --with-http_stub_status_module
      - --with-http_sub_module
      - --with-mail
      - --with-mail_ssl_module
      - --with-stream
      - --with-stream_realip_module
      - --with-stream_ssl_module
      - --with-stream_ssl_preread_module
      - --with-cc-opt='-g -O2 -ffile-prefix-map=/data/builder/debuild/nginx-1.23.3/debian/debuild-base/nginx-1.23.3=. -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -Wl,--as-needed -pie'
    override-build: |
      set -x
      craftctl default
      rm $CRAFT_PART_INSTALL/etc/nginx/nginx.conf
      mkdir -p $CRAFT_PART_INSTALL/var/cache/nginx/

  config:
    plugin: dump
    after:
      - nginx
    source: files
    organize:
      nginx.conf: etc/nginx/nginx.conf
      default.conf: etc/nginx/conf.d/default.conf
